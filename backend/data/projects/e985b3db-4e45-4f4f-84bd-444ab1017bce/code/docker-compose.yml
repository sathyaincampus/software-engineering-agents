version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sparktoship_backend
    ports:
      - "8000:8000" # Map host port 8000 to container port 8000
    volumes:
      # Mount the current directory into the container at /app
      # This allows for live code changes during development without rebuilding the image
      # Remove or comment this out for production deployments
      - .:/app
    env_file:
      # Load environment variables from a .env file
      - .env
    environment:
      # Override or set specific environment variables for the backend service
      # Ensure these match your application's requirements
      DATABASE_URL: postgresql://postgres:password@db:5432/sparktoship_db
      REDIS_HOST: redis
      SECRET_KEY: dev_secret_key_please_change_in_env_file
      # Example: Set log level
      # LOG_LEVEL: DEBUG
    depends_on:
      # Ensure the database and redis services are started before the backend
      - db
      - redis
    restart: unless-stopped # Restart the container unless it's manually stopped

  db:
    image: postgres:15-alpine # Use a specific PostgreSQL version
    container_name: sparktoship_db
    volumes:
      # Persist database data using a named volume
      - postgres_data:/var/lib/postgresql/data/
    ports:
      - "5432:5432" # Expose PostgreSQL port if needed for external access (e.g., pgAdmin)
    environment:
      # Set PostgreSQL root user credentials and database name
      POSTGRES_DB: sparktoship_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password # WARNING: Use a strong password in production environment variables
    restart: unless-stopped

  redis:
    image: redis:alpine # Use a lightweight Redis image
    container_name: sparktoship_redis
    ports:
      - "6379:6379" # Expose Redis port if needed for external access
    volumes:
      # Persist Redis data using a named volume
      - redis_data:/data
    restart: unless-stopped

  # Example for frontend service (assuming it's built into static files and served by Nginx)
  # This requires a separate Dockerfile for the frontend (e.g., Dockerfile.prod in a frontend subfolder)
  # frontend:
  #   build:
  #     context: ./frontend # Specify the path to your frontend code
  #     dockerfile: Dockerfile.prod # Specify the frontend Dockerfile
  #   container_name: sparktoship_frontend
  #   ports:
  #     - "80:80" # Serve frontend on port 80
  #   depends_on:
  #     - backend # Ensure backend is running
  #   restart: unless-stopped

# Define named volumes for data persistence
volumes:
  postgres_data:
  redis_data:
